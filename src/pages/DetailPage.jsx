// src/pages/DetailPage.jsx
import { useParams, useNavigate } from "react-router-dom";
import { useEffect, useState } from "react";
import app from "../firebase";
import {
  getFirestore,
  doc,
  setDoc,
  serverTimestamp,
  collection,
  query,
  where,
  getDocs,
} from "firebase/firestore";
import { getAuth } from "firebase/auth";
import { onSnapshot } from "firebase/firestore";
import { arrayUnion } from "firebase/firestore";
import { deleteDoc, getDoc } from "firebase/firestore";
import ServiceHeader from "../components/ServiceHeader";
import ServiceImages from "../components/ServiceImages";
import BookingPanel from "../components/BookingPanel";
import RatingAndComment from "../components/RatingAndComment";
import ServiceInfo from "../components/ServiceInfo";
import { handleBookingWithLock } from "../utils/handleBookingWithLock";






const db = getFirestore(app);
const auth = getAuth(app);

function DetailPage() {
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
  const [slots, setSlots] = useState([]);
  const { id } = useParams();
  const [service, setService] = useState(null);
  const [isFav, setIsFav] = useState(false);
  const [loading, setLoading] = useState(true);
  const navigate = useNavigate();
  const currentUser = auth.currentUser;
  const [userCompletedSlots, setUserCompletedSlots] = useState([]);
  const [userRatings, setUserRatings] = useState([]);
  const [commentText, setCommentText] = useState("");
const [comments, setComments] = useState([]);
const [displayName, setDisplayName] = useState("ÂåøÂêç");
const [visibleComments, setVisibleComments] = useState(5); // ÂàùÂßãÊòæÁ§∫ 5 Êù°
const [showBooking, setShowBooking] = useState(false);
const [hasPaid, setHasPaid] = useState(false);







useEffect(() => {
  const handleResize = () => setIsMobile(window.innerWidth < 768);
  window.addEventListener("resize", handleResize);
  return () => window.removeEventListener("resize", handleResize);
}, []);



useEffect(() => {
  const q = query(
    collection(db, "slots"),
    where("serviceId", "==", id),
    where("available", "==", true)
  );

  const unsubscribe = onSnapshot(q, (snap) => {
    const slotList = snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
    setSlots(slotList);
  });

  return () => unsubscribe();
}, [id]);



useEffect(() => {
  if (!id) return;

  const fetchService = async () => {
    const docRef = doc(db, "services", id);
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
      const data = docSnap.data();

      // üß© Ëé∑ÂèñÂïÜÂÆ∂Â§¥ÂÉè‰∏éÊòµÁß∞
      const sellerRef = doc(db, "users", data.userId);
      const sellerSnap = await getDoc(sellerRef);
      const sellerData = sellerSnap.exists() ? sellerSnap.data() : {};

      setService({
        id: docSnap.id,
        ...data,
        sellerName: sellerData.displayName || "ÂïÜÂÆ∂",
        sellerAvatar: sellerData.avatarUrl?.trim() || "https://via.placeholder.com/48",

      });

      setLoading(false);
    }
  };

  fetchService();
}, [id]);

useEffect(() => {
  if (!currentUser || !id) return;

  const checkIfPaid = async () => {
    const appointmentRef = query(
      collection(db, "appointments"),
      where("userId", "==", currentUser.uid),
      where("serviceId", "==", id),
      where("paid", "==", true)
    );
    const snap = await getDocs(appointmentRef);
    setHasPaid(!snap.empty); // ÊúâËÆ∞ÂΩïËØ¥ÊòéÂ∑≤‰ªòÊ¨æ
  };

  checkIfPaid();
}, [currentUser, id]);



  useEffect(() => {
    const fetchUserCompletedSlotsAndRatings = async () => {
      if (!currentUser) return;
  
      // Ëé∑ÂèñÁî®Êà∑Â∑≤ÂÆåÊàêÁöÑÈ¢ÑÁ∫¶
      const slotQuery = query(
        collection(db, "slots"),
        where("userId", "==", currentUser.uid),
        where("serviceId", "==", id),
        where("completed", "==", true)
      );
      const slotSnap = await getDocs(slotQuery);
      setUserCompletedSlots(slotSnap.docs.map((doc) => doc.id));
  
      // Ëé∑ÂèñËØ•Áî®Êà∑ÂØπËØ•ÊúçÂä°ÁöÑËØÑÂàÜ
      const ratingQuery = query(
        collection(db, "ratings"),
        where("userId", "==", currentUser.uid),
        where("serviceId", "==", id)
      );
      const ratingSnap = await getDocs(ratingQuery);
      setUserRatings(ratingSnap.docs.map((doc) => ({ ...doc.data(), id: doc.id })));
    };
  
    fetchUserCompletedSlotsAndRatings();
  }, [currentUser, id]);
  

  const handleMessage = async () => {
    if (!currentUser) {
      alert("ËØ∑ÂÖàÁôªÂΩïÔºÅ");
      navigate("/login");
      return;
    }
  
    const chatId = [currentUser.uid, service.userId].sort().join("_");
    const chatRef = doc(db, "chats", chatId);
    const chatSnap = await getDoc(chatRef);
  
    if (!chatSnap.exists()) {
      await setDoc(chatRef, {
        users: [currentUser.uid, service.userId],
        createdAt: serverTimestamp(),
        lastMessage: "",
        lastMessageTimestamp: serverTimestamp(),
        readTimestamps: {
          [currentUser.uid]: serverTimestamp(),
          [service.userId]: serverTimestamp(),
        },
      });
    }
  
    alert("‚úÖ È¢ÑÁ∫¶ÊàêÂäüÔºÅËØ∑Â∞ΩÂø´ÈÄöËøáËÅäÂ§©‰∏éÂïÜÂÆ∂Á°ÆËÆ§Êó∂Èó¥ÂíåÂú∞ÂùÄ„ÄÇ‰Ω†ÂèØ‰ª•Âú®‚ÄòÊàëÁöÑÈ¢ÑÁ∫¶‚Äô‰∏≠ÊâæÂà∞ÂØπÂ∫îËÅäÂ§©ÂÖ•Âè£„ÄÇ");

  

  };
  
  const handleBooking = async (slotId) => {
    if (!currentUser) {
      alert("ËØ∑ÂÖàÁôªÂΩïÂêéÂÜçÈ¢ÑÁ∫¶ÔºÅ");
      navigate("/login");
      return;
    }
  
    try {
      const res = await handleBookingWithLock({
        slotId,
        serviceId: id,
        userId: currentUser.uid,
        serviceOwnerId: service.userId,
        serviceTitle: service.title,
        servicePhone: service.phoneNumber,
        isMember: service.isMember, // ‚ö†Ô∏è Â¶ÇÊûúÊúçÂä°‰∏≠Ê≤°Êúâ isMemberÔºåÂèØÂøΩÁï•Ê≠§Ë°å
      });
  
      if (res.success) {
        const chatId = [currentUser.uid, service.userId].sort().join("_");
        const goToChat = window.confirm("‚úÖ È¢ÑÁ∫¶ËØ∑Ê±ÇÂ∑≤Êèê‰∫§ÔºåÂª∫ËÆÆÂ∞ΩÂø´ÂâçÂæÄËÅäÂ§©È°µÈù¢‰∏éÊúçÂä°ÂïÜÊ≤üÈÄö„ÄÇÊòØÂê¶Á´ãÂç≥ÂâçÂæÄÔºü");
        if (goToChat) {
          localStorage.setItem("chat_after_booking", chatId);
          navigate("/"); // ‰Ω†ÂèØ‰ª•ÊîπÊàê navigate(`/chat`) Á≠âÁõÆÊ†áÈ°µ
        }
      } else {
        alert("‚ùå " + res.message);
      }
    } catch (err) {
      console.error("È¢ÑÁ∫¶Â§±Ë¥•:", err);
      alert("È¢ÑÁ∫¶Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØïÔºÅ");
    }
  };
  
  




  const toggleFavorite = async () => {
    if (!currentUser) {
      alert("ËØ∑ÂÖàÁôªÂΩïÂÜçÊî∂ËóèÔºÅ");
      return;
    }

    const favRef = doc(db, "users", currentUser.uid, "favorites", id);
    if (isFav) {
      await setDoc(favRef, {});
      alert("Â∑≤ÂèñÊ∂àÊî∂Ëóè");
    } else {
      await setDoc(favRef, { timestamp: new Date() });
      alert("Â∑≤Êî∂ËóèÔºÅ");
    }
    setIsFav(!isFav);
  };

  const handleRatingChange = async (newRating) => {
    if (!currentUser) {
      alert("ËØ∑ÂÖàÁôªÂΩïÔºÅ");
      return;
    }
  
    if (userRatings.length > 0) {
      alert("‰Ω†Â∑≤ÁªèËØÑÂàÜËøá‰∫ÜÔºå‰∏çËÉΩÈáçÂ§çËØÑÂàÜÔºÅ");
      return;
    }
  
    if (userCompletedSlots.length === 0) {
      alert("‰Ω†ËøòÊ≤°ÊúâÂÆåÊàêËøáÊúçÂä°Ôºå‰∏çËÉΩËØÑÂàÜÔºÅ");
      return;
    }
  
    try {
      // ‚úÖ ÂÜôÂÖ•ËØÑÂàÜËÆ∞ÂΩïÔºàÂïÜÂÆ∂ÂØπÊúçÂä°ËØÑÂàÜÔºâ
      const ratingRef = doc(db, "ratings", `${currentUser.uid}_${id}`);
      await setDoc(ratingRef, {
        userId: currentUser.uid,
        serviceId: id,
        rating: newRating,
        createdAt: serverTimestamp(),
      });
  
      // ‚úÖ Êõ¥Êñ∞ÊúçÂä°Âπ≥ÂùáËØÑÂàÜ
      const q = query(collection(db, "ratings"), where("serviceId", "==", id));
      const snap = await getDocs(q);
      const ratings = snap.docs.map((doc) => doc.data().rating);
      const avg = ratings.reduce((sum, r) => sum + r, 0) / ratings.length;
  
      await setDoc(doc(db, "services", id), { rating: avg }, { merge: true });
      setService((prev) => ({ ...prev, rating: avg }));
      setUserRatings([{ rating: newRating }]);
  
      alert("ÊÑüË∞¢ËØÑÂàÜÔºÅ");
  
      // ‚úÖ ÂêåÊ≠•ÂÜôÂÖ•Âà∞ÂÆ¢‰∫∫Ê°£Ê°àÔºàÂïÜÂÆ∂ÂØπÂÆ¢‰∫∫ÁöÑËØÑ‰ª∑Ôºâ
      // Êàë‰ª¨ÈªòËÆ§Âè™ÂèñÁ¨¨‰∏Ä‰∏™ÂÆåÊàêÁöÑ slot
      const completedSlotId = userCompletedSlots[0];
      const slotRef = doc(db, "slots", completedSlotId);
      const slotSnap = await getDoc(slotRef);
  
      if (slotSnap.exists()) {
        const slotData = slotSnap.data();
        const guestUid = slotData.userId;
  
        await setDoc(
          doc(db, "users", guestUid, "receivedFromMerchants", `${id}_${completedSlotId}`),
          {
            serviceOwnerId: currentUser.uid,
            merchantName: displayName || "ÂïÜÂÆ∂",
            serviceTitle: service.title,
            rating: newRating,
            comment: "", // Â¶ÇÈúÄÂä†ËæìÂÖ•Ê°ÜÂ°´ÂÜôÔºåÂèØÊâ©Â±ï
            createdAt: serverTimestamp(),
          }
        );
      }
    } catch (error) {
      console.error("ËØÑÂàÜÂ§±Ë¥•", error);
      alert("ËØÑÂàÜÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï");
    }
  };
  

  useEffect(() => {
    const fetchComments = async () => {
      const ref = doc(db, "services", id);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        setComments(data.comments || []);
      }
    };
    fetchComments();
  }, [id]);

  const handleCommentSubmit = async (e) => {
    e.preventDefault();
    if (!commentText.trim() || !currentUser) return;
  
    const newComment = {
      id: Date.now(),
      text: commentText.trim(),
      displayName,
      createdAt: new Date().toISOString(),
      uid: currentUser.uid,
      likes: 0,
      likedBy: [],
    };
  
    // ‚úÖ ÂÜôÂÖ•ÂΩìÂâç service ÁöÑËØÑËÆ∫ÂàóË°®
    const docRef = doc(db, "services", id);
    const updated = [...comments, newComment];
    await setDoc(docRef, { comments: updated }, { merge: true });
    setComments(updated);
    setCommentText("");
    if (service?.userId) {
      const userReviewRef = doc(
        db,
        "users",
        service.userId,
        "reviews",
        `${id}_${newComment.id}`
      );
      await setDoc(userReviewRef, {

        ...newComment,
        serviceId: id,
        serviceTitle: service.title,
        serviceImage: service.images?.[0] || "",
      });
    }
  
    // ‚úÖ ÂêåÊ≠•ÂÜôÂÖ•ÂïÜÂÆ∂Ê°£Ê°àÁöÑ allCommentsÔºàÈò≤Ê≠¢ÊúçÂä°Âà†Èô§Êó∂‰∏¢Â§±ÂéÜÂè≤Ôºâ
    const sellerUid = service.userId;
    const sellerRef = doc(db, "users", sellerUid);
    await setDoc(
      sellerRef,
      {
        allComments: arrayUnion(newComment),
      },
      { merge: true }
    );
  };
  
  const handleCommentDelete = async (commentId) => {
    if (!currentUser) return;
  
    // ÊâæÂà∞ÁõÆÊ†áËØÑËÆ∫ÂØπË±°
    const target = comments.find((c) => c.id === commentId);
    if (!target || target.uid !== currentUser.uid) {
      alert("Âè™ËÉΩÂà†Èô§Ëá™Â∑±ÁöÑËØÑËÆ∫");
      return;
    }
  
    const docRef = doc(db, "services", id);
    await setDoc(docRef, {
      comments: comments.filter(c => c.id !== commentId)  // Êú¨Âú∞Êõ¥Êñ∞
    }, { merge: true });
  
    setComments(comments.filter((c) => c.id !== commentId));
  };

  const handleCommentLike = async (commentId) => {
    if (!currentUser) return;
  
    const comment = comments.find((c) => c.id === commentId);
    if (!comment) return;
  
    const alreadyLiked = comment.likedBy.includes(currentUser.uid);
    const updatedComment = {
      ...comment,
      likes: alreadyLiked ? comment.likes - 1 : comment.likes + 1,
      likedBy: alreadyLiked
        ? comment.likedBy.filter((uid) => uid !== currentUser.uid)
        : [...comment.likedBy, currentUser.uid],
    };
  
    const updatedComments = comments.map((c) =>
      c.id === commentId ? updatedComment : c
    );
  
    const docRef = doc(db, "services", id);
    await setDoc(docRef, { comments: updatedComments }, { merge: true });
    setComments(updatedComments);
  };
  
  

  useEffect(() => {
    const fetchDisplayName = async () => {
      if (!currentUser) return;
      const userRef = doc(db, "users", currentUser.uid);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists()) {
        setDisplayName(userSnap.data().displayName || "ÂåøÂêç");
      }
    };
    fetchDisplayName();
  }, [currentUser]);
  
  if (loading || !service) return <p>Âä†ËΩΩ‰∏≠...</p>;

  return (
    <div
    className="page-container"
    style={{
      maxWidth: "1277px",
      margin: "0 auto",
      padding: "2rem",
      paddingTop: "80px",
      paddingBottom: isMobile ? "6rem" : "2rem", // ‚úÖ ÁªôÂ∫ïÈÉ®ÊåâÈíÆÁïôÁ©∫Èó¥
    }}
  >
    <ServiceHeader
      title={service.title}
      isFav={isFav}
      toggleFavorite={toggleFavorite}
      sellerName={service.sellerName}
      sellerAvatar={service.sellerAvatar}
      sellerId={service.userId}
      rating={service.rating}
    />

    <ServiceImages images={service.images} />

    <div
      style={{
        display: "flex",
        flexDirection: isMobile ? "column" : "row",
        justifyContent: "space-between",
        alignItems: "flex-start",
        gap: "2rem",
      }}
    >
      {/* Â∑¶‰æßÂÜÖÂÆπ */}
      <div style={{ flex: 1 }}>
        <ServiceInfo
          description={service.description}
          price={service.price}
          location={service.location}
          tags={service.tags}
          createdAt={service.createdAt}
        />


        <RatingAndComment
          currentUser={currentUser}
          userCompletedSlots={userCompletedSlots}
          userRatings={userRatings}
          handleRatingChange={handleRatingChange}
          commentText={commentText}
          setCommentText={setCommentText}
          comments={comments}
          handleCommentSubmit={handleCommentSubmit}
          handleCommentLike={handleCommentLike}
          handleCommentDelete={handleCommentDelete}
          visibleComments={visibleComments}
          setVisibleComments={setVisibleComments}
          displayName={displayName}
          navigate={navigate}
        />
      </div>

      {/* Âè≥‰æßÈ¢ÑÁ∫¶Âç°ÁâáÔºö‰ªÖÊ°åÈù¢ÊòæÁ§∫ */}
      {!isMobile && (
        <div style={{ width: "360px" }}>
          <BookingPanel
            currentUser={currentUser}
            service={service}
            slots={slots}
            handleBooking={handleBooking}
          />
        </div>
      )}
    </div>

    {/* ÁßªÂä®Á´ØÂ∫ïÈÉ®È¢ÑÁ∫¶ÊåâÈíÆÊ†è */}
    {isMobile && (
  <>
    {/* Â∫ïÈÉ®ÊåâÈíÆ */}
    <div
      style={{
        position: "fixed",
        bottom: 0,
        left: 0,
        right: 0,
        zIndex: 1000,
        backgroundColor: "#fff",
        padding: "1rem",
        borderTop: "1px solid #ddd",
        boxShadow: "0 -2px 6px rgba(0,0,0,0.08)",
      }}
    >
      <button
        onClick={() => setShowBooking(true)}
        style={{
          width: "100%",
          padding: "1rem",
          backgroundColor: "#ff5858",
          color: "white",
          border: "none",
          borderRadius: "8px",
          fontSize: "1.1rem",
          fontWeight: "bold",
          cursor: "pointer",
        }}
      >
        Book Now üí¨
      </button>
    </div>

    {/* ‚úÖ Âè™Êúâ showBooking ‰∏∫ true Êó∂ÊòæÁ§∫ÊµÆÁ™ó */}
    {showBooking && (
      <div
  style={{
    position: "fixed",
    bottom: 0,
    left: 0,
    width: "100vw",
    height: "90vh",
    backgroundColor: "#fff",
    zIndex: 2000,
    overflowY: "auto",
    borderTopLeftRadius: "20px",
    borderTopRightRadius: "20px",
    boxShadow: "0 -4px 16px rgba(0,0,0,0.1)",
    padding: "1.5rem",
    boxSizing: "border-box",
  }}
>
  <div style={{ maxWidth: "600px", margin: "0 auto" }}>
    <BookingPanel
      currentUser={currentUser}
      service={service}
      slots={slots}
      handleBooking={handleBooking}
      isCompact
      onBookingSuccess={() => setShowBooking(false)}
      onClose={() => setShowBooking(false)}
    />
  </div>
</div>

    )}
  </>
)}

  </div>
);

}  

export default DetailPage;